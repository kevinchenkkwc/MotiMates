# Unlock Request Bug Fix + Early Exit Screen

## üêõ Problem: Host Stuck on "Request Pending..."

**Root Cause:**
The host (and sometimes guest) would get stuck showing "Request Pending..." even after the request was approved because:

1. **Creating new channels for broadcasts** - Instead of reusing the subscribed channel, we created a NEW channel each time to send a broadcast. The new channel wasn't subscribed to receive responses!

2. **Race condition with button spam** - Multiple clicks could create multiple requests/votes

## ‚úÖ Fix Applied

### 1. Store Channel in Ref
```javascript
const channelRef = useRef(null);

// In setupRealtimeSubscription:
const channel = supabase.channel(`session:${sessionId}`)...
channelRef.current = channel; // Store it!
```

### 2. Reuse Same Channel for All Broadcasts
**Before (BROKEN):**
```javascript
// Creating a NEW channel every time = won't receive responses!
const channel = supabase.channel(`session:${sessionId}`);
await channel.send({ ... });
```

**After (FIXED):**
```javascript
// Use the SAME channel we're subscribed to
if (channelRef.current) {
  await channelRef.current.send({ ... });
}
```

### 3. Better State Management
- Save reason before clearing state: `const savedReason = unlockReason;`
- Extract request data before async operations to avoid stale closures
- Clear `pendingRequest` immediately on resolution

### 4. Added Console Logs
```javascript
console.log('[Unlock] Broadcasting request to channel');
console.log('[Unlock] Broadcasting resolution:', result.status);
```

These help debug if broadcasts are sent/received.

---

## üé® New Feature: Early Exit Reflection Screen

**Path:** `/app/session/early-exit.js`

### What It Does:
When someone's unlock request is approved and they choose "Leave", they're taken to a reflection screen instead of just going home.

### Features:
1. **Shows exit reason** - Reminds them why they left
2. **Reflection input** - "How did this session go? What could you improve?"
3. **Saves to database** - Stores reflection with `early_exit: true` flag
4. **Motivational message** - "Life happens! The important thing is getting back to it."
5. **Skip option** - Can skip reflection and go straight home
6. **Success feedback** - Shows checkmark after submission

### UI:
- Exit icon at top
- Session name displayed
- Highlighted reason card
- Large text input for reflection
- Motivational box with lightbulb icon
- Submit & Skip buttons

### Flow:
```
Request Approved Alert
  ‚Üì
User taps "Leave"
  ‚Üì
Early Exit Reflection Screen
  ‚Üì
(Submit or Skip)
  ‚Üì
Home Screen
```

---

## üß™ Testing Instructions

### Test Unlock Flow (2 devices):

1. **Device A (Host):** Create session, start it
2. **Device B (Guest):** Join with code, start together
3. **Device A:** Tap "Request Unlock"
4. **Device A:** Enter reason: "Need to take a call"
5. **Device B:** Should see modal immediately (not after spam!)
6. **Device B:** Tap "Approve"
7. **Device A:** 
   - Button should change from "Request Pending..." back to normal
   - Should see "Request Approved" alert
   - Tap "Leave"
8. **Device A:** Should see Early Exit Reflection screen
9. **Device A:** Enter reflection or skip
10. **Device A:** Navigates to Home
11. **Device B:** Should still be in session (session continues!)

### Expected Console Logs:
```
[Unlock] Broadcasting request to channel
[Broadcast] Unlock request: {...}
[Unlock] Broadcasting resolution: approved
[Broadcast] Unlock resolved: {...}
```

---

## üîß Technical Details

### Why It Was Broken:
Supabase Broadcast channels work like radio frequencies:
- You subscribe to a channel = "tune in to frequency"
- You can only receive messages on channels you're subscribed to
- Creating a NEW channel to send = broadcasting on a different frequency!

### The Fix:
Store the subscribed channel in a ref and use it for ALL communication.

```javascript
// Setup once:
channelRef.current = supabase.channel(`session:${sessionId}`).subscribe();

// Use everywhere:
channelRef.current.send({ ... });
```

### Button Spam Issue:
The "spam needed" behavior was because:
1. First click might not get response (wrong channel)
2. Multiple clicks eventually created enough activity to trigger UI updates
3. Now with fixed channel, single click works!

---

## üìù Database Impact

The `reflections` table now stores:
- `early_exit: true` - Flag for early exits
- `exit_reason: "..."` - Why they left
- `reflection_text: "..."` - Their reflection

This data can be used for:
- Analytics on why people leave early
- Helping users improve study habits
- Showing reflection history

---

## ‚ú® Result

‚úÖ Host no longer stuck on "Request Pending..."
‚úÖ Guest receives notifications instantly (no spam needed)
‚úÖ Approved users get reflection screen
‚úÖ Session continues for remaining participants
‚úÖ Clear console logs for debugging
‚úÖ Better UX with feedback and motivation

Test it out - should work smoothly now! üöÄ
